from crowd.eagle_eye.sources.devto import pre_process

without_organization = {
    'canonical_url': 'https://dev.to/sokhavuth/tv-channel-website-route-to-static-assets-4dd6',
    'collection_id': 19428,
    'comments_count': 0,
    'cover_image': 'https://res.cloudinary.com/practicaldev/image/fetch/s--5Tc-jq6j--/c_imagga_scale,f_auto,fl_progressive,h_420,q_auto,w_1000/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/jfaqz6f869nib9wrqhjo.png',
    'created_at': '2022-08-22T08:49:53Z',
    'crossposted_at': None,
    'description': 'GitHub: https://github.com/Sokhavuth/TV-Channel Vercel: '
    'https://khmerweb-tv-channel.vercel.app/   In...',
    'edited_at': '2022-08-22T08:52:13Z',
    'id': 1173162,
    'last_comment_at': '2022-08-22T08:51:46Z',
    'path': '/sokhavuth/tv-channel-website-route-to-static-assets-4dd6',
    'positive_reactions_count': 0,
    'public_reactions_count': 0,
    'published_at': '2022-08-22T09:23:47Z',
    'published_timestamp': '2022-08-22T09:23:47Z',
    'readable_publish_date': 'Aug 22',
    'reading_time_minutes': 1,
    'slug': 'tv-channel-website-route-to-static-assets-4dd6',
    'social_image': 'https://res.cloudinary.com/practicaldev/image/fetch/s--H8KF-D0D--/c_imagga_scale,f_auto,fl_progressive,h_500,q_auto,w_1000/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/jfaqz6f869nib9wrqhjo.png',
    'tag_list': ['webdev', 'tutorial', 'python', 'bottle'],
    'tags': 'webdev, tutorial, python, bottle',
    'title': 'TV Channel Website: Static Assets',
    'type_of': 'article',
    'url': 'https://dev.to/sokhavuth/tv-channel-website-route-to-static-assets-4dd6',
    'user': {
        'github_username': 'Sokhavuth',
        'id': 574924,
        'joined_at': 'Feb  7, 2021',
        'location': '',
        'name': 'Khmer Web',
        'profile_image': 'https://res.cloudinary.com/practicaldev/image/fetch/s--AV2-UEv7--/c_fill,f_auto,fl_progressive,h_320,q_auto,w_320/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/574924/64f4717e-5c7d-4e0c-ba85-521c9e7e5dff.jpg',
        'summary': '',
        'twitter_username': None,
        'type_of': 'user',
        'username': 'sokhavuth',
        'website_url': 'https://khmerweb.vercel.app/'
    }
}

with_organization = {
    'canonical_url': 'https://dev.to/producthackers/do-not-reinvent-the-wheel-400g',
    'collection_id': None,
    'comments_count': 0,
    'cover_image': 'https://res.cloudinary.com/practicaldev/image/fetch/s--L688S7sq--/c_imagga_scale,f_auto,fl_progressive,h_420,q_auto,w_1000/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/9n1ihqefdv236pubhrmc.jpg',
    'created_at': '2022-07-27T10:07:45Z',
    'crossposted_at': None,
    'description': 'As a dev we are responsible in delivering value over number '
    'of lines of code, that is our focus. Do not develop a tool '
    'from zero when there are tons of them out there that cover '
    'your needs.',
    'edited_at': None,
    'id': 1152635,
    'last_comment_at': '2022-08-22T09:01:43Z',
    'organization': {
        'github_username': 'ProductHackers',
        'id': 3260,
        'joined_at': '2020-11-04T10:24:05Z',
        'location': 'Madrid, Spain',
        'name': 'Product Hackers',
        'profile_image': 'https://res.cloudinary.com/practicaldev/image/fetch/s--cdztWIwP--/c_fill,f_auto,fl_progressive,h_640,q_auto,w_640/https://dev-to-uploads.s3.amazonaws.com/uploads/organization/profile_image/3260/2d5868ca-8732-4f03-8693-fe45fe70772e.jpg',
        'story': '',
        'summary': 'We make your business grow.',
        'tag_line': '',
        'tech_stack': 'HTML, CSS, JS, React, Svelte, Nodejs, AWS',
        'twitter_username': 'Product_Hackers',
        'type_of': 'organization',
        'url': 'https://producthackers.com/',
        'username': 'producthackers'
    },
    'path': '/producthackers/do-not-reinvent-the-wheel-400g',
    'positive_reactions_count': 3,
    'public_reactions_count': 3,
    'published_at': '2022-08-22T09:01:43Z',
    'published_timestamp': '2022-08-22T09:01:43Z',
    'readable_publish_date': 'Aug 22',
    'reading_time_minutes': 4,
    'slug': 'do-not-reinvent-the-wheel-400g',
    'social_image': 'https://res.cloudinary.com/practicaldev/image/fetch/s--kNXzZN0c--/c_imagga_scale,f_auto,fl_progressive,h_500,q_auto,w_1000/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/9n1ihqefdv236pubhrmc.jpg',
    'tag_list': ['nocode', 'tools', 'gtm', 'aws'],
    'tags': 'nocode, tools, gtm, aws',
    'title': 'Do not reinvent the wheel',
    'type_of': 'article',
    'url': 'https://dev.to/producthackers/do-not-reinvent-the-wheel-400g',
    'user': {
        'github_username': 'avcconti',
        'id': 26911,
        'joined_at': 'Jul 21, 2017',
        'location': 'Toledo, Spain',
        'name': 'Conti',
        'profile_image': 'https://res.cloudinary.com/practicaldev/image/fetch/s--G2X9WGPr--/c_fill,f_auto,fl_progressive,h_320,q_auto,w_320/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/26911/d77c1deb-30d8-45ff-bb3f-a14ed63395ee.jpeg',
        'summary': 'Software engineer at https://producthackers.com/',
        'twitter_username': 'avc_conti',
        'type_of': 'user',
        'username': 'conti',
        'website_url': ''
    }
}


def test_with_organization():
    processed = pre_process([with_organization])[0]

    payload = processed.payload

    # Test the payload class
    assert payload.vectorId == 'devto:1152635'
    assert payload.sourceId == 'devto:1152635'
    assert payload.title == 'Do not reinvent the wheel'
    assert payload.url == 'https://dev.to/producthackers/do-not-reinvent-the-wheel-400g'
    assert payload.username == 'conti'
    assert payload.timestamp == 1661155303
    assert payload.platform == 'devto'
    assert payload.text == 'As a dev we are responsible in delivering value over number of lines of code, that is our focus. Do not develop a tool from zero when there are tons of them out there that cover your needs.'
    assert payload.destination_url == ''
    assert payload.postAttributes == {'tags': ['nocode', 'tools', 'gtm', 'aws'], }
    assert payload.userAttributes == {
        'user': {
            'githubUsername': 'avcconti',
            'twitterUsername': 'avc_conti',
            'location': 'Toledo, Spain',
            'joinedAt': 'Jul 21, 2017',
            'name': 'Conti',
            'summary': 'Software engineer at https://producthackers.com/',
            'website': ''
        },
        'organization': {
            'name': 'Product Hackers',
            'username': 'producthackers',
            'githubUsername': 'ProductHackers',
            'twitterUsername': 'Product_Hackers',
            'location': 'Madrid, Spain',
            'joinedAt': '2020-11-04T10:24:05Z',
            'techStack': 'HTML, CSS, JS, React, Svelte, Nodejs, AWS',
            'summary': 'We make your business grow.',
            'tagLine': ''
        }
    }

    # Test payload_as_dict
    assert processed.payload_as_dict() == {
        'destination_url': '',
        'platform': 'devto',
        'postAttributes': '{"tags": ["nocode", "tools", "gtm", "aws"]}',
        'sourceId': 'devto:1152635',
        'text': 'As a dev we are responsible in delivering value over number of lines '
        'of code, that is our focus. Do not develop a tool from zero when '
        'there are tons of them out there that cover your needs.',
        'timestamp': 1661155303,
        'title': 'Do not reinvent the wheel',
        'url': 'https://dev.to/producthackers/do-not-reinvent-the-wheel-400g',
        'userAttributes': '{"user": {"githubUsername": "avcconti", "twitterUsername": '
        '"avc_conti", "location": "Toledo, Spain", "joinedAt": "Jul '
        '21, 2017", "name": "Conti", "summary": "Software engineer '
        'at https://producthackers.com/", "website": ""}, '
        '"organization": {"name": "Product Hackers", "username": '
        '"producthackers", "githubUsername": "ProductHackers", '
        '"twitterUsername": "Product_Hackers", "location": "Madrid, '
        'Spain", "joinedAt": "2020-11-04T10:24:05Z", "techStack": '
        '"HTML, CSS, JS, React, Svelte, Nodejs, AWS", "summary": '
        '"We make your business grow.", "tagLine": ""}}',
        'username': 'conti',
        'vectorId': 'devto:1152635'
    }


def test_without_organization():
    processed = pre_process([without_organization])[0]
    payload = processed.payload

    # Test the payload class
    assert payload.vectorId == 'devto:1173162'
    assert payload.sourceId == 'devto:1173162'
    assert payload.title == 'TV Channel Website: Static Assets'
    assert payload.url == 'https://dev.to/sokhavuth/tv-channel-website-route-to-static-assets-4dd6'
    assert payload.username == 'sokhavuth'
    assert payload.timestamp == 1661156627
    assert payload.platform == 'devto'
    assert payload.text == 'GitHub: https://github.com/Sokhavuth/TV-Channel Vercel: https://khmerweb-tv-channel.vercel.app/   In...'
    assert payload.destination_url == ''
    assert payload.postAttributes == {'tags': ['webdev', 'tutorial', 'python', 'bottle']}
    assert payload.userAttributes == {
        'user': {
            'githubUsername': 'Sokhavuth',
            'twitterUsername': None,
            'location': '',
            'joinedAt': 'Feb  7, 2021',
            'name': 'Khmer Web',
            'summary': '',
            'website': ''
        },
        'organization': {}
    }

    # Test payload_as_dict
    assert processed.payload_as_dict() == {
        'destination_url': '',
        'platform': 'devto',
        'postAttributes': '{"tags": ["webdev", "tutorial", "python", "bottle"]}',
        'sourceId': 'devto:1173162',
        'text': 'GitHub: https://github.com/Sokhavuth/TV-Channel Vercel: '
        'https://khmerweb-tv-channel.vercel.app/   In...',
        'timestamp': 1661156627,
        'title': 'TV Channel Website: Static Assets',
        'url': 'https://dev.to/sokhavuth/tv-channel-website-route-to-static-assets-4dd6',
        'userAttributes': '{"user": {"githubUsername": "Sokhavuth", '
        '"twitterUsername": null, "location": "", "joinedAt": "Feb  '
        '7, 2021", "name": "Khmer Web", "summary": "", "website": '
        '""}, "organization": {}}',
        'username': 'sokhavuth',
        'vectorId': 'devto:1173162'
    }


if __name__ == '__main__':
    # test_with_organization()
    test_without_organization()
